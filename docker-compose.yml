# BundLink Docker Compose Configuration
# For self-hosted deployment

version: '3.8'

services:
  # Main Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bundlink-app
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      - NODE_ENV=production
      - PORT=5000
      - DATABASE_URL=postgresql://bundlink:${DB_PASSWORD}@postgres:5432/bundlink
      - SESSION_SECRET=${SESSION_SECRET}
      # Auth Provider: replit, keycloak, or local
      - AUTH_PROVIDER=${AUTH_PROVIDER:-keycloak}
      # Keycloak settings (if using Keycloak)
      - KEYCLOAK_URL=${KEYCLOAK_URL:-http://keycloak:8080}
      - KEYCLOAK_REALM=${KEYCLOAK_REALM:-bundlink}
      - KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID:-bundlink-app}
      - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET:-}
      # GeoIP database path
      - GEOIP_DB_PATH=/app/geoip/GeoLite2-Country.mmdb
      # Ollama AI (optional)
      - OLLAMA_URL=${OLLAMA_URL:-http://ollama:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.2}
    volumes:
      # GeoIP database (download manually from MaxMind)
      - ./geoip:/app/geoip:ro
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - bundlink-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: bundlink-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=bundlink
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=bundlink
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - bundlink-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U bundlink -d bundlink"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Keycloak Identity Provider (optional, for production auth)
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: bundlink-keycloak
    restart: unless-stopped
    command: start-dev
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin}
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://postgres:5432/keycloak
      - KC_DB_USERNAME=bundlink
      - KC_DB_PASSWORD=${DB_PASSWORD}
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - bundlink-network
    profiles:
      - keycloak

  # Ollama AI (optional, for AI features)
  ollama:
    image: ollama/ollama:latest
    container_name: bundlink-ollama
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama
    ports:
      - "11434:11434"
    networks:
      - bundlink-network
    profiles:
      - ai
    # Uncomment for GPU support (NVIDIA)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # Nginx Reverse Proxy (optional, for SSL)
  nginx:
    image: nginx:alpine
    container_name: bundlink-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - app
    networks:
      - bundlink-network
    profiles:
      - production

networks:
  bundlink-network:
    driver: bridge

volumes:
  postgres_data:
  ollama_data:
